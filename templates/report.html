<!DOCTYPE html>
<html>
<head>
    <title>SMC/ICT Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        .premium { color: red; }
        .discount { color: green; }
        .buy { color: green; font-weight: bold; }
        .sell { color: red; font-weight: bold; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>SMC/ICT Analysis</h1>
    <p>{{ current_time }} UTC-03</p>
    
    {% if error %}
    <p style="color: red;">{{ error }}</p>
    {% else %}
    <form method="POST">
        <label>Par de Divisas:</label>
        <select name="pair">
            <option value="EURUSD=X" {% if pair == 'EURUSD' %}selected{% endif %}>EURUSD</option>
            <option value="GBPUSD=X" {% if pair == 'GBPUSD' %}selected{% endif %}>GBPUSD</option>
            <option value="USDJPY=X" {% if pair == 'USDJPY' %}selected{% endif %}>USDJPY</option>
        </select>
        <label>Timeframe:</label>
        <select name="timeframe">
            <option value="15m" {% if timeframe == '15m' %}selected{% endif %}>15 Minutos</option>
            <option value="5m" {% if timeframe == '5m' %}selected{% endif %}>5 Minutos</option>
            <option value="1h" {% if timeframe == '1h' %}selected{% endif %}>1 Hora</option>
        </select>
        <label>Confluencia Mínima (%):</label>
        <input type="number" name="confluencia_min" value="{{ confluencia_min }}" min="0" max="100">
        <button type="submit">Analizar</button>
    </form>

    <h2>Resultados del Análisis</h2>
    <h3>Resumen del Mercado</h3>
    <p>Precio Actual: {{ results.price | round(5) }}</p>
    <p>Tendencia: {{ results.trend }}</p>
    <p>Última Actualización: {{ current_time }}</p>

    <h3>Contexto ICT</h3>
    <p>Kill Zone: 
        {% if kill_zone.active %}
        Activa: {{ kill_zone.name }} (Prioridad: {{ kill_zone.priority }}, Tiempo restante: {{ kill_zone.remaining }} min)
        {% else %}
        No activa
        {% endif %}
    </p>

    <h3>Premium/Discount</h3>
    <p>Zona actual: <span class="{{ 'discount' if results.zone == 'discount' else 'premium' }}">{{ results.zone }}</span></p>
    <p>Equilibrio: {{ results.equilibrium | round(5) }}</p>
    <p>Rango: {{ results.range }}</p>

    <h3>Análisis SMC</h3>
    <p>Market Structure:</p>
    <ul>
        <li>BOS: {{ 'SÍ' if results.bos else 'NO' }}</li>
        <li>CHoCH: {{ 'SÍ' if results.choch else 'NO' }}</li>
        <li>Señal: <span class="{{ 'buy' if results.recommendation.signal == 'BUY' else 'sell' }}">{{ results.recommendation.signal }}</span></li>
    </ul>

    <h3>Niveles Detectados</h3>
    <p>Niveles válidos: {{ results.levels | length }}</p>
    <p>Alta confluencia: {{ results.levels | selectattr('confluence', '>=', 80) | list | length }}</p>
    <p>Confluencia Media: {{ results.avg_confluence | round(0) }}%</p>

    <h3>Niveles de Reacción Clave</h3>
    {% for level in results.levels %}
    <p>#{{ loop.index }} <span class="{{ 'buy' if level.signal == 'BUY' else 'sell' }}">{{ level.signal }}</span></p>
    <p>{{ level.confluence }}% - {{ level.pips | round(1) }} pips</p>
    <p>Precio: {{ level.price | round(5) }}</p>
    <p>Zona de entrada: {{ level.zone }}</p>
    <p>Fuente: {{ level.source }}</p>
    <p>Razón: {{ level.reason }}</p>
    {% endfor %}

    <h3>Recomendación Final</h3>
    <p><span class="{{ 'buy' if results.recommendation.signal == 'BUY' else 'sell' }}">{{ results.recommendation.signal }}</span></p>
    <p>Confianza: {{ results.recommendation.confidence }}%</p>
    <p>Zona de entrada: {{ results.recommendation.zone }}</p>

    <canvas id="priceChart" style="max-height: 400px;"></canvas>
    <script>
        const ctx = document.getElementById('priceChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ price_times | tojson }},
                datasets: [{
                    label: 'Precio',
                    data: {{ price_data | tojson }},
                    borderColor: '#007bff',
                    fill: false
                }, {
                    label: 'Niveles Clave',
                    data: {{ chart_levels | tojson | safe }},
                    borderColor: '#ff0000',
                    type: 'scatter',
                    pointRadius: 5
                }]
            },
            options: {
                scales: {
                    x: { title: { display: true, text: 'Tiempo' } },
                    y: { title: { display: true, text: 'Precio' } }
                }
            }
        });
    </script>
    {% endif %}
</body>
</html>
